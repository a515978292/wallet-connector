# åŒºå—é“¾ä»£å¸å•ä½è½¬æ¢å®Œå…¨æŒ‡å—

> ç†è§£ balanceã€formatUnits å’Œ parseUnits çš„å·¥ä½œåŸç†

---

## ğŸ“Š é—®é¢˜èµ·æº

åœ¨ä½¿ç”¨ `useBalance` æŸ¥è¯¢ä½™é¢æ—¶ï¼Œè¿”å›çš„æ•°æ®ç»“æ„æ˜¯è¿™æ ·çš„ï¼š

```typescript
balance = {
  decimals: 18, // ç²¾åº¦ï¼ˆå°æ•°ä½æ•°ï¼‰
  symbol: "ETH", // ä»£å¸ç¬¦å·
  value: 5900000000000000n, // åŸå§‹å€¼ï¼ˆbigint ç±»å‹ï¼‰
};
```

**é—®é¢˜æ¥äº†ï¼š**

- è¿™äº›å€¼æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
- ä¸ºä»€ä¹ˆ value æ˜¯è¿™ä¹ˆå¤§çš„æ•°å­—ï¼Ÿ
- formatUnits æ˜¯å¹²ä»€ä¹ˆç”¨çš„ï¼Ÿ

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### 1. åŒºå—é“¾åªæ”¯æŒæ•´æ•°

**å…³é”®ç‚¹ï¼š** åŒºå—é“¾ï¼ˆEVMï¼‰ä¸èƒ½ç›´æ¥å¤„ç†å°æ•°ï¼Œåªèƒ½å¤„ç†æ•´æ•°ï¼

```typescript
// âŒ åŒºå—é“¾ä¸èƒ½ç›´æ¥å­˜å‚¨
balance = 0.0059 ETH

// âœ… åŒºå—é“¾å®é™…å­˜å‚¨ï¼ˆæ•´æ•°ï¼‰
balance = 5900000000000000 wei
```

**ä¸ºä»€ä¹ˆï¼Ÿ**

- æµ®ç‚¹æ•°åœ¨ä¸åŒè®¡ç®—æœºä¸Šå¯èƒ½æœ‰ç²¾åº¦è¯¯å·®
- åŒºå—é“¾éœ€è¦ç»å¯¹çš„ç¡®å®šæ€§
- æ‰€ä»¥ä½¿ç”¨å¤§æ•´æ•°æ¥è¡¨ç¤ºå°æ•°

---

## ğŸ” balance å¯¹è±¡è¯¦è§£

### valueï¼ˆåŸå§‹å€¼ï¼‰

```typescript
value: 5900000000000000n;
```

- **ç±»å‹ï¼š** `bigint`ï¼ˆæ³¨æ„åé¢çš„ `n`ï¼‰
- **å•ä½ï¼š** weiï¼ˆä»¥å¤ªåŠæœ€å°å•ä½ï¼‰
- **å«ä¹‰ï¼š** åŒºå—é“¾ä¸Šå®é™…å­˜å‚¨çš„å€¼
- **ç‰¹ç‚¹ï¼š** ä¸æ˜¯äººç±»å¯è¯»çš„æ ¼å¼

### decimalsï¼ˆç²¾åº¦ï¼‰

```typescript
decimals: 18;
```

- **å«ä¹‰ï¼š** å°æ•°ä½æ•°
- **ETH æ ‡å‡†ï¼š** 18 ä½å°æ•°
- **æ¢ç®—ï¼š** `1 ETH = 10^18 wei`

### symbolï¼ˆä»£å¸ç¬¦å·ï¼‰

```typescript
symbol: "ETH";
```

- **å«ä¹‰ï¼š** ä»£å¸åç§°/ç¬¦å·
- **ç”¨é€”ï¼š** æ˜¾ç¤ºç»™ç”¨æˆ·çœ‹

---

## ğŸ§® å•ä½æ¢ç®—

### ETH çš„å•ä½å±‚çº§

```
1 ETH (ä»¥å¤ª)
= 1,000,000,000,000,000,000 wei
= 10^18 wei

å…·ä½“ä¾‹å­ï¼š
5900000000000000 wei = 0.0059 ETH
```

### æ¢ç®—å…¬å¼

```
äººç±»å¯è¯»å€¼ = åŸå§‹å€¼ / (10 ^ decimals)

ç¤ºä¾‹ï¼š
0.0059 ETH = 5900000000000000 / (10^18)
```

---

## ğŸ”§ formatUnits å‡½æ•°è¯¦è§£

### ä½œç”¨

**å°†åŒºå—é“¾ä¸Šçš„åŸå§‹å€¼ï¼ˆweiï¼‰è½¬æ¢ä¸ºäººç±»å¯è¯»çš„æ ¼å¼ï¼ˆETHï¼‰**

### ä½¿ç”¨æ–¹æ³•

```typescript
import { formatUnits } from "viem";

// åŸºæœ¬ç”¨æ³•
const readable = formatUnits(
  5900000000000000n, // value: åŸå§‹å€¼ï¼ˆbigintï¼‰
  18 // decimals: ç²¾åº¦
);

console.log(readable); // "0.0059"ï¼ˆå­—ç¬¦ä¸²ï¼‰
```

### å·¥ä½œåŸç†

```typescript
formatUnits(value, decimals) = value / (10 ** decimals)

// å®é™…è®¡ç®—
= 5900000000000000 / (10 ** 18)
= 5900000000000000 / 1000000000000000000
= 0.0059
```

### åœ¨é¡¹ç›®ä¸­çš„ä½¿ç”¨

```typescript
// 1. ä» useBalance è·å–æ•°æ®
const { data: balance } = useBalance({ address });

// 2. è½¬æ¢ä¸ºå¯è¯»æ ¼å¼
const formatted = formatUnits(balance.value, balance.decimals);

// 3. æ ¼å¼åŒ–æ˜¾ç¤º
<p>
  {parseFloat(formatted).toFixed(4)} {balance.symbol}
</p>;

// æ˜¾ç¤ºç»“æœï¼š"0.0059 ETH"
```

---

## ğŸ”„ parseUnits å‡½æ•°ï¼ˆåå‘è½¬æ¢ï¼‰

### ä½œç”¨

**å°†äººç±»å¯è¯»çš„å€¼ï¼ˆETHï¼‰è½¬æ¢ä¸ºåŒºå—é“¾åŸå§‹å€¼ï¼ˆweiï¼‰**

### ä½¿ç”¨åœºæ™¯

å½“ä½ éœ€è¦å‘é€äº¤æ˜“æ—¶ï¼š

```typescript
import { parseUnits } from "viem";

// ç”¨æˆ·æƒ³å‘é€ 0.1 ETH
const userInput = "0.1";

// è½¬æ¢ä¸º wei
const weiAmount = parseUnits(userInput, 18);
// â†’ 100000000000000000n

// å‘é€äº¤æ˜“
sendTransaction({
  to: recipientAddress,
  value: weiAmount, // å¿…é¡»ä½¿ç”¨ wei
});
```

### å·¥ä½œåŸç†

```typescript
parseUnits(value, decimals) = value * (10 ** decimals)

// ç¤ºä¾‹
parseUnits("0.1", 18)
= 0.1 * (10^18)
= 100000000000000000n
```

---

## ğŸ’¡ å®Œæ•´è½¬æ¢æµç¨‹

### æ˜¾ç¤ºä½™é¢ï¼ˆformatUnitsï¼‰

```typescript
// Step 1: useBalance è¿”å›åŸå§‹æ•°æ®
const { data: balance } = useBalance({ address });
// balance.value = 5900000000000000n (bigint)

// Step 2: formatUnits è½¬æ¢
const formatted = formatUnits(balance.value, balance.decimals);
// formatted = "0.0059" (å­—ç¬¦ä¸²)

// Step 3: è½¬ä¸ºæ•°å­—
const number = parseFloat(formatted);
// number = 0.0059 (æ•°å­—)

// Step 4: æ ¼å¼åŒ–å°æ•°ä½
const display = number.toFixed(4);
// display = "0.0059" (å­—ç¬¦ä¸²)

// Step 5: æ˜¾ç¤º
console.log(`${display} ${balance.symbol}`);
// è¾“å‡º: "0.0059 ETH"
```

### å‘é€äº¤æ˜“ï¼ˆparseUnitsï¼‰

```typescript
// Step 1: ç”¨æˆ·è¾“å…¥
const userInput = "0.5"; // æƒ³å‘é€ 0.5 ETH

// Step 2: è½¬æ¢ä¸º wei
const weiAmount = parseUnits(userInput, 18);
// weiAmount = 500000000000000000n

// Step 3: å‘é€äº¤æ˜“
await sendTransaction({
  to: "0x...",
  value: weiAmount,
});
```

---

## ğŸ“Š å¸¸è§ä»£å¸çš„ decimals

| ä»£å¸ | Decimals | æ¢ç®—å…³ç³»              | è¯´æ˜            |
| ---- | -------- | --------------------- | --------------- |
| ETH  | 18       | 1 ETH = 10Â¹â¸ wei      | ä»¥å¤ªåŠä¸»å¸      |
| WETH | 18       | 1 WETH = 10Â¹â¸ wei     | åŒ…è£…çš„ ETH      |
| USDT | 6        | 1 USDT = 10â¶ æœ€å°å•ä½ | Tether USD      |
| USDC | 6        | 1 USDC = 10â¶ æœ€å°å•ä½ | USD Coin        |
| DAI  | 18       | 1 DAI = 10Â¹â¸ æœ€å°å•ä½ | MakerDAO ç¨³å®šå¸ |
| WBTC | 8        | 1 WBTC = 10â¸ satoshi  | åŒ…è£…çš„ BTC      |

**æ³¨æ„ï¼š** ä¸åŒä»£å¸çš„ decimals å¯èƒ½ä¸åŒï¼Œä¸€å®šè¦ç”¨æ­£ç¡®çš„ decimals å€¼ï¼

---

## ğŸ› ï¸ å®ç”¨å·¥å…·å‡½æ•°

### æ ¼å¼åŒ–ä½™é¢æ˜¾ç¤º

```typescript
/**
 * æ ¼å¼åŒ–ä½™é¢ä¸ºäººç±»å¯è¯»æ ¼å¼
 */
function formatBalance(
  value: bigint,
  decimals: number,
  symbol: string,
  fixed: number = 4
): string {
  const formatted = formatUnits(value, decimals);
  const number = parseFloat(formatted);
  return `${number.toFixed(fixed)} ${symbol}`;
}

// ä½¿ç”¨
const display = formatBalance(balance.value, balance.decimals, balance.symbol);
console.log(display); // "0.0059 ETH"
```

### å®‰å…¨çš„å•ä½è½¬æ¢

```typescript
/**
 * å®‰å…¨åœ°å°†ç”¨æˆ·è¾“å…¥è½¬æ¢ä¸º wei
 */
function safeParseUnits(input: string, decimals: number): bigint | null {
  try {
    // éªŒè¯è¾“å…¥
    if (!input || isNaN(Number(input))) {
      return null;
    }

    // è½¬æ¢
    return parseUnits(input, decimals);
  } catch (error) {
    console.error("è½¬æ¢å¤±è´¥:", error);
    return null;
  }
}

// ä½¿ç”¨
const amount = safeParseUnits("0.1", 18);
if (amount) {
  // å®‰å…¨ä½¿ç”¨
  sendTransaction({ value: amount });
}
```

### æ ¼å¼åŒ–ä¸ºä¸åŒç²¾åº¦

```typescript
/**
 * æ ¹æ®é‡‘é¢å¤§å°è‡ªåŠ¨è°ƒæ•´æ˜¾ç¤ºç²¾åº¦
 */
function smartFormat(value: bigint, decimals: number, symbol: string): string {
  const formatted = formatUnits(value, decimals);
  const number = parseFloat(formatted);

  // æ ¹æ®é‡‘é¢å¤§å°è°ƒæ•´ç²¾åº¦
  if (number >= 1000) {
    return `${number.toFixed(2)} ${symbol}`; // å¤§é¢ï¼š2ä½
  } else if (number >= 1) {
    return `${number.toFixed(4)} ${symbol}`; // ä¸­é¢ï¼š4ä½
  } else {
    return `${number.toFixed(6)} ${symbol}`; // å°é¢ï¼š6ä½
  }
}

// ä½¿ç”¨
smartFormat(5000000000000000000n, 18, "ETH"); // "5.00 ETH"
smartFormat(1500000000000000000n, 18, "ETH"); // "1.5000 ETH"
smartFormat(5900000000000000n, 18, "ETH"); // "0.005900 ETH"
```

---

## âš ï¸ å¸¸è§é”™è¯¯

### 1. ç›´æ¥ä½¿ç”¨ value æ˜¾ç¤º

```typescript
// âŒ é”™è¯¯ï¼šæ˜¾ç¤ºçš„æ˜¯ weiï¼Œä¸æ˜¯ ETH
<p>{balance.value} ETH</p>
// æ˜¾ç¤ºï¼š5900000000000000 ETHï¼ˆé”™è¯¯ï¼ï¼‰

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ formatUnits è½¬æ¢
<p>{formatUnits(balance.value, balance.decimals)} ETH</p>
// æ˜¾ç¤ºï¼š0.0059 ETH
```

### 2. ä½¿ç”¨é”™è¯¯çš„ decimals

```typescript
// âŒ é”™è¯¯ï¼šUSDT çš„ decimals æ˜¯ 6ï¼Œä¸æ˜¯ 18
const formatted = formatUnits(usdtBalance, 18);

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ä»£å¸å®é™…çš„ decimals
const formatted = formatUnits(usdtBalance, 6);
```

### 3. å­—ç¬¦ä¸²å’Œæ•°å­—æ··æ·†

```typescript
// âŒ é”™è¯¯ï¼šformatUnits è¿”å›å­—ç¬¦ä¸²
const total = formatUnits(balance.value, 18) + 10;
// ç»“æœï¼š"0.005910"ï¼ˆå­—ç¬¦ä¸²æ‹¼æ¥ï¼‰

// âœ… æ­£ç¡®ï¼šå…ˆè½¬ä¸ºæ•°å­—
const total = parseFloat(formatUnits(balance.value, 18)) + 10;
// ç»“æœï¼š10.0059
```

### 4. ç²¾åº¦ä¸¢å¤±

```typescript
// âš ï¸ æ³¨æ„ï¼šJavaScript çš„ number ç±»å‹æœ‰ç²¾åº¦é™åˆ¶
const value = 1234567890123456789n;
const number = Number(value); // å¯èƒ½ä¸¢å¤±ç²¾åº¦

// âœ… æ¨èï¼šå…ˆè½¬æ¢å•ä½ï¼Œå†è½¬ä¸ºæ•°å­—
const eth = parseFloat(formatUnits(value, 18)); // å®‰å…¨
```

---

## ğŸ“ è®°å¿†å£è¯€

```
åŒºå—é“¾åªå­˜æ•´æ•°ï¼Œå°æ•°é ç²¾åº¦
formatUnits ç»™äººçœ‹ï¼ŒparseUnits ç»™é“¾ç”¨
ETH åå…«ä½å°æ•°ï¼ŒUSDT åªæœ‰å…­
è½¬æ¢è®°å¾—çœ‹ decimalsï¼Œä¸åŒä»£å¸ä¸ä¸€æ ·
```

---

## ğŸ“ å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹  1ï¼šè®¡ç®— Gas è´¹

```typescript
// å‡è®¾ Gas ä»·æ ¼æ˜¯ 30 gweiï¼Œæ¶ˆè€—äº† 21000 gas
const gasPrice = 30n * 10n ** 9n; // 30 gwei = 30 * 10^9 wei
const gasUsed = 21000n;
const gasCost = gasPrice * gasUsed;

// è½¬æ¢ä¸º ETH æ˜¾ç¤º
const ethCost = formatUnits(gasCost, 18);
console.log(`Gas è´¹: ${ethCost} ETH`);
// è¾“å‡ºï¼š"Gas è´¹: 0.00063 ETH"
```

### ç»ƒä¹  2ï¼šéªŒè¯ç”¨æˆ·è¾“å…¥

```typescript
function validateAmount(
  input: string,
  maxBalance: bigint,
  decimals: number
): boolean {
  try {
    // è½¬æ¢ç”¨æˆ·è¾“å…¥
    const amount = parseUnits(input, decimals);

    // éªŒè¯æ˜¯å¦è¶…è¿‡ä½™é¢
    if (amount > maxBalance) {
      alert("ä½™é¢ä¸è¶³");
      return false;
    }

    // éªŒè¯æ˜¯å¦ä¸ºæ­£æ•°
    if (amount <= 0n) {
      alert("é‡‘é¢å¿…é¡»å¤§äº 0");
      return false;
    }

    return true;
  } catch (error) {
    alert("æ— æ•ˆçš„é‡‘é¢");
    return false;
  }
}
```

### ç»ƒä¹  3ï¼šè®¡ç®—ç™¾åˆ†æ¯”

```typescript
// è®¡ç®—ä½™é¢çš„ 50%
function calculatePercentage(balance: bigint, percentage: number): bigint {
  return (balance * BigInt(percentage)) / 100n;
}

// ä½¿ç”¨
const halfBalance = calculatePercentage(balance.value, 50);
console.log(`50% ä½™é¢: ${formatUnits(halfBalance, 18)} ETH`);
```

---

## ğŸ”— ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£

- [Viem - formatUnits](https://viem.sh/docs/utilities/formatUnits.html)
- [Viem - parseUnits](https://viem.sh/docs/utilities/parseUnits.html)
- [Ethereum Units](https://ethereum.org/en/developers/docs/intro-to-ether/#denominations)

### åœ¨çº¿å·¥å…·

- [ETH Unit Converter](https://eth-converter.com/) - ETH å•ä½è½¬æ¢å™¨
- [Etherscan Unit Converter](https://etherscan.io/unitconverter) - å®˜æ–¹å•ä½è½¬æ¢å·¥å…·

---

## ğŸ’¡ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **åŒºå—é“¾åªå­˜æ•´æ•°** â†’ ä½¿ç”¨ bigint ç±»å‹
2. **decimals æ˜¯ç²¾åº¦** â†’ ä¸åŒä»£å¸ä¸åŒï¼ˆETH=18, USDT=6ï¼‰
3. **formatUnits** â†’ æ˜¾ç¤ºç»™ç”¨æˆ·ï¼ˆwei â†’ ETHï¼‰
4. **parseUnits** â†’ å‘é€äº¤æ˜“ï¼ˆETH â†’ weiï¼‰
5. **æ°¸è¿œä½¿ç”¨æ­£ç¡®çš„ decimals** â†’ å¦åˆ™ä¼šå‡ºé”™

### å¿«é€Ÿå‚è€ƒ

```typescript
// æ˜¾ç¤ºä½™é¢
formatUnits(balance.value, balance.decimals);

// å‘é€äº¤æ˜“
parseUnits(userInput, 18);

// å®Œæ•´ç¤ºä¾‹
const display = `${parseFloat(formatUnits(balance.value, 18)).toFixed(4)} ETH`;
```

---

**å­¦ä¹ æ—¥æœŸï¼š** 2024-12

**ä¸‹ä¸€æ­¥å­¦ä¹ ï¼š**

- ERC20 ä»£å¸æ ‡å‡†
- æ™ºèƒ½åˆçº¦äº¤äº’
- äº¤æ˜“ç¡®è®¤æµç¨‹
